name: QA Portfolio CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  lint:
    name: Lint (Python style checks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install linters
        run: pip install ruff black
      
      - name: Run ruff
        run: ruff check pages autotests || true
      
      - name: Run black
        run: black --check pages autotests || true

  ui-tests:
    name: UI tests (pytest + Selenium)
    runs-on: ubuntu-latest
    env:
      HEADLESS: "1"
      REPORTS_DIR: reports/ui
      REUSE_BROWSER: "0"
      WAIT_TIMEOUT: "15"
      PAGE_LOAD_TIMEOUT: "45"
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
          echo "CHROME_BIN=/usr/bin/google-chrome" >> $GITHUB_ENV
          echo "Chrome version: $CHROME_VERSION"
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-xdist pytest-timeout
      
      - name: Run pytest
        env:
          PYTHONPATH: ${{ github.workspace }}
          PHONE_NUMBER: ${{ secrets.AZERCELL_PHONE_NUMBER }}
        run: |
          mkdir -p "$REPORTS_DIR"
          pytest -v --timeout=180 \
            --junitxml="$REPORTS_DIR/ui-junit.xml" \
            --tb=short
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-reports
          path: ${{ env.REPORTS_DIR }}
          retention-days: 7

  api-tests:
    name: API tests (Postman + Newman)
    runs-on: ubuntu-latest
    env:
      REPORTS_DIR: reports/api
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      
      - name: Install Newman
        run: npm install -g newman newman-reporter-html newman-reporter-junitfull
      
      - name: Setup environment
        run: |
          mkdir -p "$REPORTS_DIR"
          ENV_FILE="postman/environments/restful-booker.postman_environment.json"
          if [ ! -f "$ENV_FILE" ]; then
            mkdir -p "$(dirname "$ENV_FILE")"
            cat > "$ENV_FILE" << 'EOF'
          {
            "id": "ci-environment",
            "name": "Restful Booker CI",
            "values": [
              {"key": "baseUrl", "value": "https://restful-booker.herokuapp.com", "enabled": true},
              {"key": "username", "value": "admin", "enabled": true},
              {"key": "password", "value": "password123", "enabled": true},
              {"key": "token", "value": "", "enabled": true},
              {"key": "bookingId", "value": "", "enabled": true}
            ]
          }
          EOF
          fi
      
      - name: Run Newman
        run: |
          COLLECTION="postman/collections/restful-booker.postman_collection.json"
          ENV_FILE="postman/environments/restful-booker.postman_environment.json"
          
          if [ -f "$COLLECTION" ]; then
            newman run "$COLLECTION" -e "$ENV_FILE" \
              --reporters cli,junit,html \
              --reporter-junit-export "$REPORTS_DIR/postman-junit.xml" \
              --reporter-html-export "$REPORTS_DIR/postman-results.html" \
              --timeout-request 30000 \
              --bail
          else
            echo "Collection not found, skipping Newman tests"
          fi
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-reports
          path: ${{ env.REPORTS_DIR }}
          retention-days: 7