name: QA Portfolio CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  lint:
    name: Lint (Python style checks)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install linters
        run: pip install ruff black

      - name: Run ruff
        run: ruff check pages autotests

      - name: Run black
        run: black --check pages autotests

  ui-tests:
    name: UI tests (pytest + Selenium)
    runs-on: ubuntu-latest
    needs: lint
    env:
      TEST_ENV: ci
      BASE_URL: https://www.azercell.com/en
      HEADLESS: "1"
      REPORTS_DIR: reports/ui
      REUSE_BROWSER: "0"
      WAIT_TIMEOUT: "15"
      PAGE_LOAD_TIMEOUT: "45"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | \
            sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] \
            http://dl.google.com/linux/chrome/deb/ stable main" \
            > /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

          echo "CHROME_BIN=/usr/bin/google-chrome" >> "$GITHUB_ENV"
          google-chrome --version

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-xdist pytest-timeout pytest-rerunfailures

      - name: Run pytest (smoke on push/PR, smoke+regression nightly)
        env:
          PYTHONPATH: ${{ github.workspace }}
          PHONE_NUMBER: ${{ secrets.AZERCELL_PHONE_NUMBER }}
        run: |
          mkdir -p "$REPORTS_DIR"

          # Default = fast smoke suite for push/PR
          MARK_EXPR="smoke"

          # Nightly scheduled run executes wider regression pack
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MARK_EXPR="smoke or regression"
          fi

          echo "Running pytest with markers: $MARK_EXPR"

          pytest autotests \
            -m "$MARK_EXPR" \
            -v \
            --timeout=180 \
            --junitxml="$REPORTS_DIR/ui-junit.xml" \
            --tb=short

      - name: Upload UI reports & screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-artifacts
          path: ${{ env.REPORTS_DIR }}
          retention-days: 7

  api-tests:
    name: API tests (Postman + Newman)
    runs-on: ubuntu-latest
    needs: lint
    env:
      REPORTS_DIR: reports/api

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Newman
        run: |
          npm install -g \
            newman \
            newman-reporter-html \
            newman-reporter-junitfull

      - name: Setup environment
        run: |
          mkdir -p "$REPORTS_DIR"
          ENV_FILE="postman/environments/restful-booker.postman_environment.json"

          if [ ! -f "$ENV_FILE" ]; then
            mkdir -p "$(dirname "$ENV_FILE")"
            cat > "$ENV_FILE" << 'EOF'
          {
            "id": "ci-environment",
            "name": "Restful Booker CI",
            "values": [
              {
                "key": "baseUrl",
                "value": "https://restful-booker.herokuapp.com",
                "enabled": true
              },
              {
                "key": "username",
                "value": "admin",
                "enabled": true
              },
              {
                "key": "password",
                "value": "password123",
                "enabled": true
              },
              {
                "key": "token",
                "value": "",
                "enabled": true
              },
              {
                "key": "bookingId",
                "value": "",
                "enabled": true
              }
            ]
          }
          EOF
          fi

      - name: Run Newman
        run: |
          COLLECTION="postman/collections/restful-booker.postman_collection.json"
          ENV_FILE="postman/environments/restful-booker.postman_environment.json"

          if [ -f "$COLLECTION" ]; then
            newman run "$COLLECTION" -e "$ENV_FILE" \
              --reporters cli,junit,html \
              --reporter-junit-export \
                "$REPORTS_DIR/postman-junit.xml" \
              --reporter-html-export \
                "$REPORTS_DIR/postman-results.html" \
              --timeout-request 30000 \
              --bail
          else
            echo "Collection not found, skipping Newman tests"
          fi

      - name: Upload API reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-artifacts
          path: ${{ env.REPORTS_DIR }}
          retention-days: 7

  perf-smoke:
    name: API performance smoke (k6)
    runs-on: ubuntu-latest
    needs: api-tests
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    env:
      BASE_URL: https://restful-booker.herokuapp.com

    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 smoke test
        uses: grafana/run-k6-action@v1
        with:
          path: performance/restful-booker-smoke.js
          flags: --env BASE_URL=${{ env.BASE_URL }} --vus 5 --duration 30s